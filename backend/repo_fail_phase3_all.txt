============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\kcjai\AppData\Local\Programs\Python\Python310\python.exe
cachedir: .pytest_cache
rootdir: D:\Projects\omnichannel-agentic-commerce\backend
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.3.0, cov-6.2.1
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 13 items

tests/unit/test_repositories.py::test_cart_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_order_repository_roundtrip_and_idempotency FAILED
tests/unit/test_repositories.py::test_memory_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_auth_repository_roundtrip_user_and_refresh PASSED
tests/unit/test_repositories.py::test_interaction_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_support_repository_roundtrip_open_tickets PASSED
tests/unit/test_repositories.py::test_session_repository_count_cached PASSED
tests/unit/test_repositories.py::test_session_repository_find_latest_for_user PASSED
tests/unit/test_repositories.py::test_session_repository_cleanup_expired_sessions PASSED
tests/unit/test_repositories.py::test_product_and_inventory_repositories_roundtrip PASSED
tests/unit/test_repositories.py::test_notification_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_category_repository_roundtrip_in_memory FAILED
tests/unit/test_repositories.py::test_admin_activity_repository_roundtrip_in_memory PASSED

================================== FAILURES ===================================
_______________ test_order_repository_roundtrip_and_idempotency _______________

    def test_order_repository_roundtrip_and_idempotency() -> None:
        store = InMemoryStore()
        mongo_manager, _ = _fake_managers()
        repo = OrderRepository(store=store, mongo_manager=mongo_manager)
    
        order = {
            "id": "order_test_1",
            "userId": "user_test_1",
            "status": "confirmed",
            "items": [],
            "subtotal": 0.0,
            "tax": 0.0,
            "shipping": 0.0,
            "discount": 0.0,
            "total": 0.0,
            "shippingAddress": {},
            "payment": {},
            "timeline": [],
            "tracking": {"updates": []},
            "estimatedDelivery": store.iso_now(),
            "createdAt": store.iso_now(),
            "updatedAt": store.iso_now(),
        }
    
        repo.create(order)
        loaded = repo.get("order_test_1")
        assert loaded is not None
        assert loaded["userId"] == "user_test_1"
    
>       listed = repo.list_by_user("user_test_1")

tests\unit\test_repositories.py:278: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app\repositories\order_repository.py:43: in list_by_user
    payloads = list(collection.find({"userId": user_id}).sort("createdAt", -1))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = [{'orderId': 'order_test_1', 'id': 'order_test_1', 'userId': 'user_test_1', 'status': 'confirmed', 'items': [], 'subto...26:17.385380+00:00', 'createdAt': '2026-02-28T12:26:17.385380+00:00', 'updatedAt': '2026-02-28T12:26:17.385380+00:00'}]
args = ('createdAt', -1), kwargs = {}

    def sort(self, *args: Any, **kwargs: Any) -> "FakeCursor":
>       super().sort(*args, **kwargs)
E       TypeError: sort() takes no positional arguments

tests\unit\test_repositories.py:91: TypeError
________________ test_category_repository_roundtrip_in_memory _________________

    def test_category_repository_roundtrip_in_memory() -> None:
        store = InMemoryStore()
        mongo_manager, redis_manager = _fake_managers()
        repo = CategoryRepository(
            store=store,
            mongo_manager=mongo_manager,
            redis_manager=redis_manager,
        )
    
        category = {
            "id": "fitness",
            "slug": "fitness",
            "name": "Fitness",
            "description": "Fitness products",
            "status": "active",
            "createdAt": store.iso_now(),
            "updatedAt": store.iso_now(),
        }
        repo.create(category)
    
        by_id = repo.get("fitness")
        assert by_id is not None
        assert by_id["name"] == "Fitness"
    
>       listed = repo.list_all()

tests\unit\test_repositories.py:602: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app\repositories\category_repository.py:27: in list_all
    rows = list(collection.find({}).sort("name", 1))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = [{'categoryId': 'fitness', 'id': 'fitness', 'slug': 'fitness', 'name': 'Fitness', 'description': 'Fitness products', 'status': 'active', 'createdAt': '2026-02-28T12:26:20.429489+00:00', 'updatedAt': '2026-02-28T12:26:20.429489+00:00'}]
args = ('name', 1), kwargs = {}

    def sort(self, *args: Any, **kwargs: Any) -> "FakeCursor":
>       super().sort(*args, **kwargs)
E       TypeError: sort() takes no positional arguments

tests\unit\test_repositories.py:91: TypeError
=========================== short test summary info ===========================
FAILED tests/unit/test_repositories.py::test_order_repository_roundtrip_and_idempotency
FAILED tests/unit/test_repositories.py::test_category_repository_roundtrip_in_memory
======================== 2 failed, 11 passed in 3.98s =========================
