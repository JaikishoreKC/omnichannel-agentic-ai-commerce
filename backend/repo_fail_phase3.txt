============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\kcjai\AppData\Local\Programs\Python\Python310\python.exe
cachedir: .pytest_cache
rootdir: D:\Projects\omnichannel-agentic-commerce\backend
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.3.0, cov-6.2.1
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 13 items

tests/unit/test_repositories.py::test_cart_repository_roundtrip_in_memory FAILED
tests/unit/test_repositories.py::test_order_repository_roundtrip_and_idempotency PASSED
tests/unit/test_repositories.py::test_memory_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_auth_repository_roundtrip_user_and_refresh PASSED
tests/unit/test_repositories.py::test_interaction_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_support_repository_roundtrip_open_tickets PASSED
tests/unit/test_repositories.py::test_session_repository_count_cached PASSED
tests/unit/test_repositories.py::test_session_repository_find_latest_for_user PASSED
tests/unit/test_repositories.py::test_session_repository_cleanup_expired_sessions PASSED
tests/unit/test_repositories.py::test_product_and_inventory_repositories_roundtrip PASSED
tests/unit/test_repositories.py::test_notification_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_category_repository_roundtrip_in_memory PASSED
tests/unit/test_repositories.py::test_admin_activity_repository_roundtrip_in_memory PASSED

================================== FAILURES ===================================
__________________ test_cart_repository_roundtrip_in_memory ___________________

    def test_cart_repository_roundtrip_in_memory() -> None:
        store = InMemoryStore()
        mongo_manager, redis_manager = _fake_managers()
        repo = CartRepository(store=store, mongo_manager=mongo_manager, redis_manager=redis_manager)
    
        cart = {
            "id": "cart_test_1",
            "userId": None,
            "sessionId": "session_test_1",
            "items": [],
            "subtotal": 0.0,
            "tax": 0.0,
            "shipping": 0.0,
            "discount": 0.0,
            "total": 0.0,
            "itemCount": 0,
            "currency": "USD",
            "appliedDiscount": None,
            "createdAt": store.iso_now(),
            "updatedAt": store.iso_now(),
        }
    
        repo.create(cart)
>       loaded = repo.get_for_user_or_session(user_id=None, session_id="session_test_1")

tests\unit\test_repositories.py:218: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app\repositories\cart_repository.py:37: in get_for_user_or_session
    persisted = self._read_from_mongo(user_id=user_id, session_id=session_id)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.repositories.cart_repository.CartRepository object at 0x0000022A63F155A0>

    def _read_from_mongo(self, *, user_id: str | None, session_id: str) -> dict[str, Any] | None:
        collection = self._mongo_collection()
        if collection is None:
            return None
    
        if user_id:
            payload = collection.find_one(
                {
                    "userId": user_id,
                    "$or": [{"status": "active"}, {"status": {"$exists": False}}],
                },
                sort=[("updatedAt", -1)],
            )
        else:
>           payload = collection.find_one(
                {
                    "sessionId": session_id,
                    "$and": [
                        {"$or": [{"userId": None}, {"userId": {"$exists": False}}]},
                        {"$or": [{"status": "active"}, {"status": {"$exists": False}}]},
                    ],
                },
                sort=[("updatedAt", -1)],
            )
E           TypeError: _FakeMongoCollection.find_one() got an unexpected keyword argument 'sort'

app\repositories\cart_repository.py:115: TypeError
=========================== short test summary info ===========================
FAILED tests/unit/test_repositories.py::test_cart_repository_roundtrip_in_memory
======================== 1 failed, 12 passed in 6.56s =========================
