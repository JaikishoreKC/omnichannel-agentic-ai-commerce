============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\kcjai\AppData\Local\Programs\Python\Python310\python.exe
cachedir: .pytest_cache
rootdir: D:\Projects\omnichannel-agentic-commerce\backend
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.3.0, cov-6.2.1
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/unit/test_repositories.py::test_product_and_inventory_repositories_roundtrip FAILED

================================== FAILURES ===================================
______________ test_product_and_inventory_repositories_roundtrip ______________

    def test_product_and_inventory_repositories_roundtrip() -> None:
        store = InMemoryStore()
        mongo_manager, redis_manager = _fake_managers()
        product_repo = ProductRepository(
            store=store,
            mongo_manager=mongo_manager,
            redis_manager=redis_manager,
        )
        inventory_repo = InventoryRepository(
            store=store,
            mongo_manager=mongo_manager,
            redis_manager=redis_manager,
        )
    
        product = {
            "id": "prod_test_100",
            "name": "Repo Product",
            "description": "Created in repository test",
            "category": "gear",
            "price": 19.99,
            "currency": "USD",
            "images": [],
            "variants": [{"id": "var_test_100", "size": "M", "color": "black", "inStock": True}],
            "rating": 0.0,
            "reviewCount": 0,
        }
        product_repo.create(product)
    
        loaded = product_repo.get("prod_test_100")
        assert loaded is not None
        assert loaded["name"] == "Repo Product"
    
        categories = product_repo.list_categories()
        assert "gear" in categories
    
        stock = {
            "variantId": "var_test_100",
            "productId": "prod_test_100",
            "totalQuantity": 8,
            "reservedQuantity": 0,
            "availableQuantity": 8,
            "updatedAt": store.iso_now(),
        }
        inventory_repo.upsert(stock)
        loaded_stock = inventory_repo.get("var_test_100")
        assert loaded_stock is not None
        assert loaded_stock["availableQuantity"] == 8
    
        product_repo.set_variant_stock_flag(variant_id="var_test_100", in_stock=False)
        updated = product_repo.get("prod_test_100")
        assert updated is not None
        variant = next(item for item in updated["variants"] if item["id"] == "var_test_100")
>       assert variant["inStock"] is False
E       assert True is False

tests\unit\test_repositories.py:502: AssertionError
=========================== short test summary info ===========================
FAILED tests/unit/test_repositories.py::test_product_and_inventory_repositories_roundtrip
============================== 1 failed in 0.29s ==============================
