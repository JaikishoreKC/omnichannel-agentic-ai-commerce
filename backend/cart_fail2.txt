============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0 -- C:\Users\kcjai\AppData\Local\Programs\Python\Python310\python.exe
cachedir: .pytest_cache
rootdir: D:\Projects\omnichannel-agentic-commerce\backend
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.3.0, cov-6.2.1
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/unit/test_repositories.py::test_cart_repository_roundtrip_in_memory FAILED

================================== FAILURES ===================================
__________________ test_cart_repository_roundtrip_in_memory ___________________

    def test_cart_repository_roundtrip_in_memory() -> None:
        store = InMemoryStore()
        mongo_manager, redis_manager = _fake_managers()
        repo = CartRepository(store=store, mongo_manager=mongo_manager, redis_manager=redis_manager)
    
        cart = {
            "id": "cart_test_1",
            "userId": None,
            "sessionId": "session_test_1",
            "items": [],
            "subtotal": 0.0,
            "tax": 0.0,
            "shipping": 0.0,
            "discount": 0.0,
            "total": 0.0,
            "itemCount": 0,
            "currency": "USD",
            "appliedDiscount": None,
            "createdAt": store.iso_now(),
            "updatedAt": store.iso_now(),
        }
    
        repo.create(cart)
>       loaded = repo.get_for_user_or_session(user_id=None, session_id="session_test_1")

tests\unit\test_repositories.py:222: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app\repositories\cart_repository.py:37: in get_for_user_or_session
    persisted = self._read_from_mongo(user_id=user_id, session_id=session_id)
app\repositories\cart_repository.py:115: in _read_from_mongo
    payload = collection.find_one(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <test_repositories._FakeMongoCollection object at 0x0000029622672350>
filter = {'$and': [{'$or': [{'userId': None}, {'userId': {'$exists': False}}]}, {'$or': [{'status': 'active'}, {'status': {'$exists': False}}]}], 'sessionId': 'session_test_1'}
sort = [('updatedAt', -1)]

    def find_one(self, filter: dict[str, Any], sort: list[tuple[str, int]] | None = None) -> dict[str, Any] | None:
        res = self.find(filter)
        if sort:
            # Very basic sort for the fake
            for field, direction in reversed(sort):
>               res.sort(key=lambda x: x.get(field), reverse=(direction == -1))
E               TypeError: _FakeMongoCollection.find.<locals>.FakeCursor.sort() got an unexpected keyword argument 'reverse'

tests\unit\test_repositories.py:84: TypeError
=========================== short test summary info ===========================
FAILED tests/unit/test_repositories.py::test_cart_repository_roundtrip_in_memory
============================== 1 failed in 0.44s ==============================
