# Security Guidelines

This document defines the v1 security requirements for the omnichannel agentic commerce platform.

## Scope

- In scope: REST API and WebSocket API security controls for v1.
- Out of scope: regulatory/compliance workflows and GraphQL-specific controls.

## Authentication and Authorization

### Authentication

- Protected endpoints require authentication.
- Public endpoints:
  - `GET /health`
  - `POST /auth/register`
  - `POST /auth/login`
  - `POST /auth/refresh`
  - Product browse/search endpoints
  - Anonymous cart/session bootstrap endpoints
- JWT uses `RS256` signing.
- Access token TTL: 15 minutes.
- Refresh token TTL: 7 days.
- Refresh tokens must rotate on every successful refresh.
- Admin accounts require MFA.
- Session cookies must be `Secure`, `HttpOnly`, and `SameSite=Lax` (or stricter).

### Authorization

- Role-based access control (RBAC) roles: `customer`, `agent`, `admin`.
- Default deny for all privileged actions.
- Authorization checks must exist in both API layer and service layer.

### Role Permissions

| Role | Cart | Orders | Products | Users | Admin | Analytics |
|------|------|--------|----------|-------|-------|-----------|
| Customer | Read/Write own | Read/Write own | Read | - | - | - |
| Agent | Read/Write all | Read/Write all | Read | Read | - | - |
| Admin | Full | Full | Full | Full | Full | Full |

## Data Protection

### Data Classification

- Public: product catalog and standard pricing.
- Internal: preferences, interaction summaries, operational metadata.
- Confidential: PII and payment-related artifacts.
- Restricted: credentials, secrets, signing keys.

### PII Handling

- Encrypt PII at rest using AES-256-GCM or equivalent managed encryption.
- Never log raw PII; mask sensitive values in logs.
- Retention is environment-defined (dev/staging/prod) and managed by operations policy.

### Data Transmission

- TLS 1.3 required for client-facing endpoints.
- HSTS enabled with one-year max age.
- Certificate pinning for mobile clients when mobile clients are introduced.

## API Security

### Endpoint Protection

- Protected endpoints require valid access token.
- REST request size limit: 10 MB.
- WebSocket connections must validate origin and enforce heartbeat/ping-pong.

### REST API Guidelines

- Use consistent error shapes without leaking implementation details.
- Implement pagination for list endpoints.
- Validate `Content-Type` on mutation endpoints.
- Reject malformed or duplicated critical headers.

### GraphQL Security

- Out of scope for v1 (REST + WebSocket only).

## Input Validation

### Validation Layers

1. Client-side validation for UX only.
2. API schema validation (Pydantic).
3. Service-layer business rule validation.
4. Database constraints and index validation.

### Input Sanitization

- Sanitize all user-controlled text.
- Use parameterized database queries and safe drivers only.
- Validate file type, extension, and size for uploads.
- Prevent path traversal in file handling paths.

### Validation Rules (Examples)

```python
email: RFC-compatible email format
phone: E.164 format
password: min 12 chars, upper/lower/number/symbol
credit_card_token: provider-issued token (never raw PAN storage)
url: RFC 3986 compatible URL
```

## Rate Limiting

### Rate Limit Tiers (Per Minute)

| Tier | Requests/Minute | Burst | Use Case |
|------|------------------|-------|----------|
| Anonymous | 60 | 10 | Unauthenticated browse/cart/session traffic |
| Authenticated | 300 | 50 | Standard signed-in users |
| Premium | 1000 | 200 | Paid tiers |
| Admin | 2000 | 500 | Admin operations |
| Critical | Unlimited | N/A | Internal payment callback lanes only |

### Rate Limit Headers

- `X-RateLimit-Limit`
- `X-RateLimit-Remaining`
- `X-RateLimit-Reset`
- `Retry-After`

### Rate Limit Implementation

- Use sliding window or token bucket.
- Apply limits by user ID, IP, and endpoint group.
- Progressive abuse penalties:
  - 1st violation: warning
  - 2nd violation: 1-hour block
  - 3rd violation: 24-hour block
  - 4th violation: manual review

## Encryption Requirements

### Encryption at Rest

- Database encryption for sensitive fields.
- Encrypted backups with separate key policies.
- Secrets and keys stored in a dedicated secret manager.

### Encryption in Transit

- TLS 1.3 minimum.
- Perfect forward secrecy required.
- Allow only strong modern cipher suites.

### Key Management

- Signing/encryption keys must not be stored in source control.
- Rotate signing keys every 30 days.
- Rotate data-encryption keys every 90 days.

## Security Headers

### Required HTTP Headers

```http
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-{random}'; style-src 'self' 'unsafe-inline'
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Referrer-Policy: strict-origin-when-cross-origin
Permissions-Policy: geolocation=(), microphone=(), camera=()
Cache-Control: no-store, no-cache, must-revalidate, private
Pragma: no-cache
```

### CORS Configuration

- Use explicit origin allowlists (no wildcard with credentials).
- Restrict methods and headers to required sets.
- Validate `Origin` for browser requests.

## Audit Logging

### Logged Events

- Authentication attempts and token refresh events.
- Authorization failures and role changes.
- Sensitive data read/write/delete actions.
- Admin actions and configuration changes.
- Security events (rate-limit violations, suspicious patterns).
- Business events (orders, payments, refunds).

### Log Retention

- Application logs: 30 days.
- Security/audit logs: 1 year.
- Long-term archival retention is environment policy driven.

### Log Protection

- Append-only where supported.
- Integrity checks (hash/chaining) for security logs.
- Least-privilege access to log stores.
- Alerting on anomalous authentication, authorization, and admin activity.

## Incident Response

### Severity Levels

| Level | Description | Response Time |
|-------|-------------|---------------|
| P1 - Critical | Active breach, data exposure | Immediate |
| P2 - High | Potential breach, system compromise | 1 hour |
| P3 - Medium | Policy/security control violation | 4 hours |
| P4 - Low | Minor security issue | 24 hours |

### Response Procedure

1. Detection
2. Analysis
3. Containment
4. Eradication
5. Recovery
6. Post-incident review

### Communication Plan

- Internal: Security team -> CTO -> CEO escalation path.
- External: Legal -> PR when customer communication is required.
- Regulatory communication is out of scope for current v1 planning.
